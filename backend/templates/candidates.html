<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SELECTIQ Junior - Candidats</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" type="text/css" href="../static/css/candidates.css">
  <style>
    /* Add styles for auto-imported rows */
    tr.auto-imported {
      background-color: rgba(59, 130, 246, 0.1) !important;
      animation: highlightRow 2s ease;
    }
    
    @keyframes highlightRow {
      0% { background-color: rgba(16, 185, 129, 0.3); }
      100% { background-color: rgba(59, 130, 246, 0.1); }
    }
    
    .import-status {
      font-size: 0.8em;
      color: #10b981;
      margin-left: 8px;
    }
  </style>
</head>
<body>
  <nav>
    <div class="brand">
      <i class="fas fa-briefcase"></i>
      <span>SELECTIQ Junior</span>
    </div>
    <div class="menu">
      <a href="dashboard.html"><i class="fas fa-briefcase"></i> Offers</a>
      <a href="apps.html"><i class="fas fa-file-alt"></i> Apps</a>
      <a href="candidates.html" class="active"><i class="fas fa-users"></i> Candidats</a>
      <a href="interview.html"><i class="fas fa-user-clock"></i> Interviews</a>
      <a href="#"><i class="fas fa-th-large"></i> Dashboard</a>
      <a href="#"><i class="fas fa-envelope"></i> Mail</a>
    </div>
    
    <div class="profile-container">
      <button class="profile-btn" onclick="toggleProfileDropdown()">
        <img src="../static/assets/icon.jpg" alt="Profile" class="profile-img">
        <i class="fas fa-caret-down"></i>
      </button>
      <div class="profile-dropdown" id="profileDropdown">
        <a href="#" onclick="openModal('profile-modal')"><i class="fas fa-user"></i> My Profil</a>
        <a href="login.html" onclick="logout(event)"><i class="fas fa-sign-out-alt"></i> Disconnect</a>
      </div>
    </div>
  </nav>

  <div class="main-content">
    <div class="table-header">
      <h2 class="table-title">Candidates</h2>
      <div class="table-controls">
        <input type="text" class="search-box" placeholder="Rechercher candidats..." id="searchInput">
        <button class="apply-btn" onclick="syncCandidates()">
          <i class="fas fa-sync-alt"></i> Sync Data
        </button>
      </div>
    </div>

    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>Full Name</th>
            <th>Email</th>
            <th>Job Title</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="candidatesTableBody">
          <!-- Candidates will be loaded here dynamically -->
          <tr>
            <td colspan="5" style="text-align: center;">
              <i class="fas fa-spinner fa-spin"></i> Loading candidates...
            </td>
          </tr>
        </tbody>
      </table>
    </div>
    
    <div class="pagination-container">
      <div class="pagination-info" id="paginationInfo">Loading...</div>
      <div class="pagination-controls">
        <span class="pagination-stats" id="pageStats">10 per page</span>
        <div class="pagination-buttons" id="paginationButtons">
          <button class="pagination-btn" id="prevPageBtn" disabled onclick="changePage(currentPage - 1)">←</button>
          <button class="pagination-btn active" onclick="changePage(1)">1</button>
          <button class="pagination-btn" id="nextPageBtn" disabled onclick="changePage(currentPage + 1)">→</button>
        </div>
      </div>
    </div>
  </div>

  <!-- View More Modal -->
  <div id="viewMoreModal" class="modal">
    <div class="modal-content">
      <div class="modalviewmore-header">
        <h3>Candidate Details</h3>
        <span class="close-modalviewmore" onclick="closeModal('viewMoreModal')">&times;</span>
      </div>
      <div class="modal-body">
        <div class="modal-field">
          <label>Full Name:</label>
          <span id="modal-fullname"></span>
        </div>
        <div class="modal-field">
          <label>Email:</label>
          <span id="modal-email"></span>
        </div>
        <div class="modal-field">
          <label>Job Title:</label>
          <span id="modal-jobtitle"></span>
        </div>
        <div class="modal-field">
          <label>Status:</label>
          <span id="modal-status"></span>
        </div>
        <div class="modal-field">
          <label>Application Date:</label>
          <span id="modal-date"></span>
        </div>
      </div>
    </div>
  </div>

  <!-- Profile Modal -->
  <div class="profile-modal" id="profile-modal">
    <div>
      <div class="modal-header">
        <h2><i class="fas fa-user"></i> My Profile</h2>
        <button class="close-modals" onclick="closeModals('profile-modal')">&times;</button>
      </div>
      <div class="profile-info">
        <img src="../static/assets/icon.jpg" alt="Profile" class="profile-pic-large">
        <div class="profile-details">
          <h3>Admin User</h3>
          <p><i class="fas fa-envelope"></i> selectiqad@gmail.com</p>
          <p><i class="fas fa-user-tag"></i> Senior Administrator</p>
          <p><i class="fas fa-calendar-alt"></i> Member since: 08/15/2025</p>
        </div>
      </div>
      <div style="text-align: center;">
        <button class="apply-btn" onclick="closeModals('profile-modal')">
          <i class="fas fa-times"></i> Close
        </button>
      </div>
    </div>
  </div>

  <footer>
    <p>
      © 2025 <strong>SelectIQ Junior</strong> — All Rights Reserved
    </p>
  </footer>

  <script src="{{ url_for('static', filename='js/api.js') }}"></script>
  <script>
    // Global variables
    let candidatesData = [];
    let currentPage = 1;
    const itemsPerPage = 10;
    let filteredData = [];

    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', function() {
      addStatusStyles();
      initEventListeners();
      loadCandidates();
    });

    // Add status styles to the page
    function addStatusStyles() {
      const style = document.createElement('style');
      style.textContent = `
        .status-pending { background-color: #f59e0b; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.8em; }
        .status-reviewed { background-color: #3b82f6; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.8em; }
        .status-interview { background-color: #8b5cf6; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.8em; }
        .status-rejected { background-color: #ef4444; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.8em; }
        .status-accepted { background-color: #10b981; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.8em; }
      `;
      document.head.appendChild(style);
    }

    // Initialize event listeners
    function initEventListeners() {
      const searchInput = document.getElementById('searchInput');
      
      if (searchInput) {
        searchInput.addEventListener('input', handleSearch);
      }
    }

    // Handle search input
    function handleSearch() {
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      filterCandidates(searchTerm);
    }

    // Filter candidates based on search term
    function filterCandidates(searchTerm) {
      filteredData = candidatesData.filter(candidate => {
        return candidate.full_name.toLowerCase().includes(searchTerm) ||
               candidate.email.toLowerCase().includes(searchTerm) ||
               candidate.job_title.toLowerCase().includes(searchTerm);
      });
      
      currentPage = 1;
      renderCandidates(filteredData);
    }

    // Load candidates from the database
    async function loadCandidates() {
      try {
        showLoadingState(true);
        
        // Load from the database
        candidatesData = await ApiService.getCandidates();
        console.log('Loaded candidates from database:', candidatesData.length);
        
        filteredData = [...candidatesData];
        renderCandidates(filteredData);
        
      } catch (error) {
        console.error('Error loading candidates:', error);
        showErrorState('Failed to load candidates. Please try again.');
      } finally {
        showLoadingState(false);
      }
    }

    // Manual sync with database
    async function syncCandidates() {
      await loadCandidates();
    }

    // Show loading state
    function showLoadingState(show) {
      const tbody = document.getElementById('candidatesTableBody');
      if (!tbody) return;

      if (show) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;"><i class="fas fa-spinner fa-spin"></i> Loading...</td></tr>';
      }
    }

    // Show error state
    function showErrorState(message) {
      const tbody = document.getElementById('candidatesTableBody');
      if (!tbody) return;

      tbody.innerHTML = `
        <tr>
          <td colspan="5" style="text-align:center;color:#ef4444;">
            ${message}
            <button onclick="loadCandidates()" style="
              background: #3b82f6;
              color: white;
              border: none;
              padding: 5px 10px;
              border-radius: 4px;
              margin-top: 5px;
              cursor: pointer;
            ">Try Again</button>
          </td>
        </tr>
      `;
    }

    // Render candidates in table
    function renderCandidates(data) {
      const tbody = document.getElementById('candidatesTableBody');
      if (!tbody) return;

      if (!data || data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">No candidates found</td></tr>';
        updatePagination(0);
        return;
      }

      // Apply pagination
      const startIndex = (currentPage - 1) * itemsPerPage;
      const endIndex = startIndex + itemsPerPage;
      const paginatedData = data.slice(startIndex, endIndex);

      tbody.innerHTML = paginatedData.map(candidate => `
        <tr class="${candidate.recentlyImported ? 'auto-imported' : ''}">
          <td>${candidate.full_name}</td>
          <td>${candidate.email}</td>
          <td>${candidate.job_title}</td>
          <td>
            <span class="status-${candidate.status}">${getStatusText(candidate.status)}</span>
          </td>
          <td>
            <div class="dropdown">
              <i class="fas fa-ellipsis-v three-dots"></i>
              <div class="dropdown-content">
                <a href="#" onclick="viewCandidateDetails(${candidate.id}); return false;">View Details</a>
                <a href="#" onclick="updateCandidateStatus(${candidate.id}, 'interview'); return false;">Mark for Interview</a>
                <a href="#" onclick="deleteCandidate(${candidate.id}, '${candidate.full_name}'); return false;" style="color: #ef4444;">
                  <i class="fas fa-trash"></i> Delete
                </a>
              </div>
            </div>
          </td>
        </tr>
      `).join('');

      initDropdowns();
      updatePagination(data.length);
    }

    // Get status text
    function getStatusText(status) {
      const statusMap = {
        pending: 'Pending',
        reviewed: 'Reviewed',
        interview: 'Interview',
        rejected: 'Rejected',
        accepted: 'Accepted'
      };
      return statusMap[status] || status;
    }

    // Initialize dropdown menus
    function initDropdowns() {
      document.querySelectorAll('.three-dots').forEach(dot => {
        dot.addEventListener('click', function(e) {
          e.stopPropagation();
          const dropdown = this.nextElementSibling;
          dropdown.classList.toggle('show');
          document.querySelectorAll('.dropdown-content').forEach(d => {
            if (d !== dropdown) d.classList.remove('show');
          });
        });
      });

      window.addEventListener('click', () => {
        document.querySelectorAll('.dropdown-content').forEach(d => {
          d.classList.remove('show');
        });
      });
    }

    // Update pagination
    function updatePagination(totalItems) {
      const totalPages = Math.ceil(totalItems / itemsPerPage);
      const paginationInfo = document.getElementById('paginationInfo');
      const prevPageBtn = document.getElementById('prevPageBtn');
      const nextPageBtn = document.getElementById('nextPageBtn');

      const startItem = (currentPage - 1) * itemsPerPage + 1;
      const endItem = Math.min(currentPage * itemsPerPage, totalItems);
      
      if (paginationInfo) {
        paginationInfo.textContent = `Showing ${startItem} to ${endItem} of ${totalItems} candidates`;
      }

      if (prevPageBtn) {
        prevPageBtn.disabled = currentPage === 1;
      }
      
      if (nextPageBtn) {
        nextPageBtn.disabled = currentPage === totalPages || totalPages === 0;
      }

      const buttons = document.querySelectorAll('.pagination-buttons button');
      buttons.forEach(btn => {
        if (btn.id !== 'prevPageBtn' && btn.id !== 'nextPageBtn') {
          btn.remove();
        }
      });

      const paginationButtons = document.getElementById('paginationButtons');
      if (paginationButtons) {
        for (let i = 1; i <= totalPages; i++) {
          const pageBtn = document.createElement('button');
          pageBtn.className = `pagination-btn ${i === currentPage ? 'active' : ''}`;
          pageBtn.textContent = i;
          pageBtn.onclick = () => changePage(i);
          nextPageBtn.parentNode.insertBefore(pageBtn, nextPageBtn);
        }
      }
    }

    // Change page
    function changePage(page) {
      currentPage = page;
      renderCandidates(filteredData);
    }

    // View candidate details
    async function viewCandidateDetails(candidateId) {
      try {
        const candidate = candidatesData.find(c => c.id === candidateId);
        if (candidate) {
          document.getElementById('modal-fullname').textContent = candidate.full_name;
          document.getElementById('modal-email').textContent = candidate.email;
          document.getElementById('modal-jobtitle').textContent = candidate.job_title;
          document.getElementById('modal-status').textContent = getStatusText(candidate.status);
          document.getElementById('modal-date').textContent = formatDate(candidate.created_at);
          
          document.getElementById('viewMoreModal').style.display = 'block';
        }
      } catch (error) {
        console.error('Error viewing candidate details:', error);
        showNotification('Error loading candidate details', 'error');
      }
    }

    // Update candidate status
    async function updateCandidateStatus(candidateId, newStatus) {
      try {
        await ApiService.updateCandidate(candidateId, { status: newStatus });
        
        // Update local data
        const candidateIndex = candidatesData.findIndex(c => c.id === candidateId);
        if (candidateIndex !== -1) {
          candidatesData[candidateIndex].status = newStatus;
        }
        
        // Update filtered data
        const filteredCandidateIndex = filteredData.findIndex(c => c.id === candidateId);
        if (filteredCandidateIndex !== -1) {
          filteredData[filteredCandidateIndex].status = newStatus;
        }
        
        renderCandidates(filteredData);
        showNotification('Candidate status updated successfully!', 'success');
      } catch (error) {
        console.error('Error updating candidate status:', error);
        showNotification('Error updating candidate status', 'error');
      }
    }

    // In candidates.html - Update the deleteCandidate function
async function deleteCandidate(candidateId, candidateName) {
    if (!confirm(`Are you sure you want to delete candidate "${candidateName}"?`)) {
        return;
    }
    
    try {
        showNotification('Deleting candidate...', 'info');
        await ApiService.deleteCandidate(candidateId);
        showNotification('Candidate deleted successfully', 'success');
        loadCandidates(); // Refresh the table
    } catch (error) {
        console.error('Error deleting candidate:', error);
        showNotification('Failed to delete candidate', 'error');
    }
}

    // Format date
    function formatDate(dateString) {
      if (!dateString) return 'N/A';
      try {
        const date = new Date(dateString);
        return isNaN(date) ? 'N/A' : date.toLocaleDateString('fr-FR');
      } catch {
        return 'N/A';
      }
    }

    // Show notification
    function showNotification(message, type = 'info') {
      // Remove any existing notification
      const existingNotification = document.getElementById('candidateNotification');
      if (existingNotification) {
        existingNotification.remove();
      }
      
      // Create notification element
      const notification = document.createElement('div');
      notification.id = 'candidateNotification';
      notification.style = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 20px;
        border-radius: 6px;
        color: white;
        z-index: 10000;
        font-weight: 500;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        background-color: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#3b82f6'};
      `;
      
      notification.textContent = message;
      document.body.appendChild(notification);
      
      // Auto-remove after 3 seconds
      setTimeout(() => {
        if (notification.parentNode) {
          notification.parentNode.removeChild(notification);
        }
      }, 3000);
    }

    // Toggle profile dropdown
    function toggleProfileDropdown() {
      const dropdown = document.getElementById('profileDropdown');
      dropdown.classList.toggle('show');
    }

    // Open modal
    function openModal(modalId) {
      document.getElementById(modalId).style.display = 'flex';
      document.getElementById('profileDropdown').classList.remove('show');
    }

    // Close modal
    function closeModal(modalId) {
      document.getElementById(modalId).style.display = 'none';
    }

    // Close modal when clicking outside
    window.onclick = function(event) {
      const modal = document.getElementById('viewMoreModal');
      if (event.target === modal) {
        closeModal('viewMoreModal');
      }
      
      const profileModal = document.getElementById('profile-modal');
      if (event.target === profileModal) {
        closeModal('profile-modal');
      }
    };

    // Logout function
    function logout(event) {
      event.preventDefault();
      if (confirm('Are you sure you want to logout?')) {
        ApiService.logout().then(() => {
          window.location.href = 'login.html';
        }).catch(error => {
          console.error('Logout error:', error);
          window.location.href = 'login.html';
        });
      }
    }
  </script>
</body>
</html>
