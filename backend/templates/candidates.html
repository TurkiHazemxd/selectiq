<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SELECTIQ Junior - Candidats</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" type="text/css" href="../static/css/candidates.css" />
<style>
  
</style>
</head>
<body>
  <nav>
    <div class="brand">
      <i class="fas fa-briefcase"></i>
      <span>SELECTIQ Junior</span>
    </div>
    <div class="menu">
      <a href="dashboard.html"><i class="fas fa-briefcase"></i> Offers</a>
      <a href="apps.html"><i class="fas fa-file-alt"></i> Apps</a>
      <a href="candidates.html" class="active"><i class="fas fa-users"></i> Candidats</a>
      <a href="interview.html"><i class="fas fa-user-clock"></i> Interviews</a>
      <a href="#" onclick="showDashboard()"><i class="fas fa-th-large"></i> Dashboard</a>
      <a href="#"><i class="fas fa-envelope"></i> Mail</a>
    </div>
    
     <div class="profile-container">
      <button class="profile-btn" onclick="toggleProfileDropdown()">
        <img src="../static/assets/icon.jpg" alt="Profile" class="profile-img">
        <i class="fas fa-caret-down"></i>
      </button>
      <div class="profile-dropdown" id="profileDropdown">
        <a href="#" onclick="openModal('profile-modal')"><i class="fas fa-user"></i> My Profil</a>
        <a href="login.html" onclick="logout(event)"><i class="fas fa-sign-out-alt"></i> Disconnect</a>
      </div>
    </div>
  </nav>

  <div class="main-content">
    <div class="table-header">
      
      <div class="table-controls">
        <input type="text" class="search-box" placeholder="Rechercher candidats...">
        
      </div>
    </div>

    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>Full Name</th>
            <th>Mail</th>
            <th>JobOffer</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="applicationsTableBody">
          <!-- Les candidatures seront charg√©es ici dynamiquement -->
        </tbody>
      </table>
    </div>
    <div class="pagination-container">
        <div class="pagination-info">Showing 1 - 8 of 66 Entries</div>
        <div class="pagination-controls">
          <span class="pagination-stats">By pe Net</span>
          <div class="pagination-buttons">
            <button class="pagination-btn">‚Üê</button>
            <button class="pagination-btn active">1</button>
            <button class="pagination-btn">2</button>
            <button class="pagination-btn">3</button>
            <button class="pagination-btn">‚Üí</button>
          </div>
        </div>
      </div>
    

  <!-- Details Modal -->
  <div id="detailsModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal()">&times;</span>
      <div class="modal-header">
        <h3 id="modalTitle" align="center">D√©tails de la candidature</h3>
      </div>
      <div class="modal-body">
        <div class="detail-row">
          <span class="detail-label">Nom complet :</span>
          <span class="detail-value" id="modalFullName"></span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Email :</span>
          <span class="detail-value" id="modalEmail"></span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Poste :</span>
          <span class="detail-value" id="modalJobTitle"></span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Formation :</span>
          <span class="detail-value" id="modalEducation"></span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Statut :</span>
          <span class="detail-value" id="modalStatus"></span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Date :</span>
          <span class="detail-value" id="modalDate"></span>
        </div>
      </div>
    </div>
  </div>
<!-- Profile Modal -->
  <div class="profile-modal" id="profile-modal">
    <div>
      <div class="modal-header">
        <h2><i class="fas fa-user"></i> My Profile</h2>
        <button class="close-modals" onclick="closeModals('profile-modal')">&times;</button>
      </div>
      <div class="profile-info">
        <img src="../static/assets/icon.jpg" alt="Profile" class="profile-pic-large">
        <div class="profile-details">
          <h3>Admin User</h3>
          <p><i class="fas fa-envelope"></i> selectiqad@gmail.com</p>
          <p><i class="fas fa-user-tag"></i> Senior Administrator</p>
          <p><i class="fas fa-calendar-alt"></i> Member since: 08/15/2025</p>
        </div>
      </div>
      <div style="text-align: center;">
        <button class="apply-btn" onclick="closeModals('profile-modal')">
          <i class="fas fa-times"></i> Close
        </button>
      </div>
    </div>
  </div>
  <!-- Add this modal HTML after the existing detailsModal -->
<!-- View More Modal -->
<div id="viewMoreModal" class="modal">
  <div class="modal-content">
    <div class="modalviewmore-header">
      <h3>Candidat Details</h3>
      <span class="close-modalviewmore" onclick="closeModalviewmore('viewMoreModal')">&times;</span>
    </div>
    <div class="modal-body">
      <div class="modal-field">
        <label>Full Name :</label>
        <span id="modal-fullname"></span>
      </div><br>
      <div class="modal-field">
        <label>Education level :</label>
        <span id="modal-education"></span>
      </div>
    </div>
  </div>
</div>
 <footer>
  <p>
    ¬© 2025 <strong>SelectIQ Junior</strong> ‚Äî All Rights Reserved
    <a href="login.html" class="admin-link"></a>
  </p>
</footer>


  <script>
  // Global variable to store applications
  let applicationsData = [];
  let refreshInterval = null;
  let autoImportInterval = null;

  // Process application data with consistent field names
  function processApplicationData(app) {
    const timestamp = app.timestamp ? new Date(app.timestamp) : new Date();
    
    // Handle both French and English field names
    const firstName = app.prenom || app.firstName || '';
    const lastName = app.nom || app.name || '';
    const fullName = `${firstName} ${lastName}`.trim();
    
    return {
      id: app.id || app.timestamp || Date.now().toString(),
      date: app.date || timestamp.toLocaleDateString('fr-FR'),
      time: app.time || timestamp.toLocaleTimeString('fr-FR', {hour: '2-digit', minute:'2-digit'}),
      fullName: fullName || app.fullName || 'N/A',
      email: app.email || 'N/A',
      jobTitle: app.jobTitle,
      educationLevel: app.formation || app.educationLevel || 'Non sp√©cifi√©',
      status: app.status || 'pending',
      timestamp: app.timestamp || Date.now()
    };
  }

  // Load applications from localStorage
  function loadApplications() {
    try {
      showLoadingState(true);
      
      // Load from localStorage
      const localData = localStorage.getItem('jobApplications');
      if (localData) {
        try {
          applicationsData = JSON.parse(localData).map(processApplicationData);
          renderApplications(applicationsData);
        } catch (e) {
          console.error('Error parsing local data:', e);
          showErrorState('Erreur de chargement des donn√©es locales');
        }
      } else {
        showNoDataState();
      }
    } catch (error) {
      console.error('Loading failed:', error);
      showErrorState('Erreur de chargement');
    } finally {
      showLoadingState(false);
    }
  }

  // Show loading state
  function showLoadingState(show) {
    const tbody = document.getElementById("applicationsTableBody");
    if (!tbody) return;
    
    if (show) {
      tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;"><i class="fas fa-spinner fa-spin"></i> Chargement...</td></tr>';
    }
  }

  // Show error state
  function showErrorState(message) {
    const tbody = document.getElementById("applicationsTableBody");
    if (!tbody) return;
    
    tbody.innerHTML = `
      <tr>
        <td colspan="4" style="text-align:center;color:#ef4444;">
          ${message}
          <button onclick="retryLoading()" style="
            background: #3b82f6;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            margin-top: 5px;
            cursor: pointer;
          ">R√©essayer</button>
        </td>
      </tr>
    `;
  }

  // Show no data state
  function showNoDataState() {
    const tbody = document.getElementById("applicationsTableBody");
    if (!tbody) return;
    
    tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;">Aucune candidature trouv√©e</td></tr>';
  }

  // Retry loading
  function retryLoading() {
    loadApplications();
  }

  // Show application details in modal
  function showApplicationDetails(appId) {
    const app = applicationsData.find(a => a.id === appId);
    if (!app) return;
    
    // Populate modal with application data
    document.getElementById('modalFullName').textContent = app.fullName;
    document.getElementById('modalEmail').textContent = app.email;
    document.getElementById('modalJobTitle').textContent = app.jobTitle;
    document.getElementById('modalEducation').textContent = app.educationLevel;
    document.getElementById('modalStatus').textContent = getStatusText(app.status);
    document.getElementById('modalDate').textContent = `${app.date} √† ${app.time}`;
    
    // Show modal
    document.getElementById('detailsModal').style.display = 'block';
  }

  // Close modal
  function closeModal() {
    document.getElementById('detailsModal').style.display = 'none';
  } 

  // Render applications in table
  function renderApplications(data) {
    const tbody = document.getElementById("applicationsTableBody");
    if (!tbody) return;

    if (!data || data.length === 0) {
      showNoDataState();
      return;
    }

    tbody.innerHTML = data.map(app => `
      <tr>
        <td>${app.fullName}</td>
        <td>${app.email}</td>
        <td>${app.jobTitle}</td>
        <td>
          <div class="status-container">
            <span class="status-${app.status.toLowerCase()}">${getStatusText(app.status)}</span>
            <div class="dropdown">
              <i class="fas fa-ellipsis-v three-dots"></i>
              <div class="dropdown-content">
                <a href="#" onclick="openCandidateModal('${app.fullName}', '${app.educationLevel}'); return false;">View More</a>
                <a href="#" onclick="deleteApplication(event, '${app.id}')" style="color: #ef4444;">Supprimer</a>
              </div>
            </div>
          </div>
        </td>
      </tr>
    `).join('');

    initDropdowns();
  }

  // Get status text in French
  function getStatusText(status) {
    const statusMap = {
      'pending': 'En attente',
      'reviewed': 'Examin√©',
      'interview': 'Entretien',
      'rejected': 'Rejet√©',
      'accepted': 'Accept√©'
    };
    return statusMap[status] || status;
  }

  // Change application status
  function changeStatus(event, id, newStatus) {
    event.preventDefault();
    const appIndex = applicationsData.findIndex(app => app.id === id);
    if (appIndex !== -1) {
      applicationsData[appIndex].status = newStatus;
      localStorage.setItem('jobApplications', JSON.stringify(applicationsData));
      renderApplications(applicationsData);
    }
  }

  // Delete application
  function deleteApplication(event, id) {
    event.preventDefault();
    if (confirm('√ätes-vous s√ªr de vouloir supprimer cette candidature ?')) {
      applicationsData = applicationsData.filter(app => app.id !== id);
      localStorage.setItem('jobApplications', JSON.stringify(applicationsData));
      renderApplications(applicationsData);
    }
  }

  // Initialize dropdown menus
  function initDropdowns() {
    document.querySelectorAll('.three-dots').forEach(dot => {
      dot.addEventListener('click', function(e) {
        e.stopPropagation();
        const dropdown = this.nextElementSibling;
        dropdown.classList.toggle('show');
        document.querySelectorAll('.dropdown-content').forEach(d => {
          if (d !== dropdown) d.classList.remove('show');
        });
      });
    });
    
    window.addEventListener('click', () => {
      document.querySelectorAll('.dropdown-content').forEach(d => {
        d.classList.remove('show');
      });
    });
  }

  // Initialize search functionality
  function initSearch() {
    const searchBox = document.querySelector('.search-box');
    searchBox?.addEventListener('input', function() {
      const searchTerm = this.value.toLowerCase();
      const filteredData = applicationsData.filter(app => 
        app.fullName.toLowerCase().includes(searchTerm) ||
        app.email.toLowerCase().includes(searchTerm) ||
        app.jobTitle.toLowerCase().includes(searchTerm)
      );
      renderApplications(filteredData);
    });
  }

  // Initialize filter functionality
  function initFilter() {
    const filterSelect = document.querySelector('.filter-select');
    filterSelect?.addEventListener('change', function() {
      const filterValue = this.value;
      const filteredData = filterValue 
        ? applicationsData.filter(app => app.jobTitle.includes(filterValue))
        : applicationsData;
      renderApplications(filteredData);
    });
  }

 

  // Close modal when clicking outside
  window.addEventListener('click', function(event) {
    const modal = document.getElementById('detailsModal');
    if (event.target === modal) {
      closeModal();
    }
  });

  // Function to show notification
  function showNotification(message, type = 'info') {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    
    // Add icon and message
    let icon = 'info-circle';
    if (type === 'success') icon = 'check-circle';
    if (type === 'error') icon = 'exclamation-circle';
    
    notification.innerHTML = `
      <i class="fas fa-${icon}"></i>
      <span>${message}</span>
    `;
    
    // Add to body
    document.body.appendChild(notification);
    
    // Show notification
    setTimeout(() => {
      notification.classList.add('show');
    }, 100);
    
    // Hide after 5 seconds
    setTimeout(() => {
      notification.classList.remove('show');
      setTimeout(() => {
        document.body.removeChild(notification);
      }, 300);
    }, 5000);
  }

  



  // Initialize everything when DOM is loaded
  document.addEventListener("DOMContentLoaded", () => {
    
    initSearch();
    initFilter();
    
    // Load applications from localStorage
    loadApplications();
    
    
    
    // Check if there's a new application to add (from the form)
    checkForNewApplication();
    
    // Initialize automatic import system
    initializeImportTracking();
    startAutomaticImport();
  });

  // Check for new application from the form
  function checkForNewApplication() {
    const urlParams = new URLSearchParams(window.location.search);
    const newApp = urlParams.get('newApplication');
    
    if (newApp) {
      try {
        const applicationData = JSON.parse(decodeURIComponent(newApp));
        
        // Get existing applications
        const existingApplications = JSON.parse(localStorage.getItem('jobApplications') || '[]');
        
        // Add new application with unique ID
        applicationData.id = Date.now().toString();
        applicationData.timestamp = new Date().toISOString();
        applicationData.status = 'pending';
        
        existingApplications.push(applicationData);
        
        // Save back to localStorage
        localStorage.setItem('jobApplications', JSON.stringify(existingApplications));
        localStorage.setItem('jobApplicationsPrevious', JSON.stringify(existingApplications));
        
        // Reload the table
        loadApplications();
        
        // Show notification
        showNotification('Nouvelle candidature ajout√©e!', 'success');
        
        // Clean the URL
        window.history.replaceState({}, document.title, window.location.pathname);
      } catch (e) {
        console.error('Error processing new application:', e);
        showNotification('Erreur lors de l\'ajout de la candidature', 'error');
      }
    }
  }

  
  
  
  
  function logout(event) {
    event.preventDefault();
    console.log('Logging out...');
    window.location.href = 'login.html';
  }
  
  function showDashboard() {
    console.log('Showing dashboard...');
  }

  // Function to simulate form submission (for testing)
  function simulateFormSubmission() {
    const sampleData = {
      nom: 'Dupont',
      prenom: 'Jean',
      email: 'jean.dupont@example.com',
      poste: 'D√©veloppeur Frontend React',
      formation: 'Master Informatique'
    };
    
    // Encode the data as URL parameter
    const encodedData = encodeURIComponent(JSON.stringify(sampleData));
    
    // Redirect to this page with the data as parameter
    window.location.href = `new.html?newApplication=${encodedData}`;
  }
  
  // ==================== AUTOMATIC IMPORT SYSTEM ====================
  
  // Initialize automatic import when page loads
  // Update these functions in candidates.html
function initializeImportTracking() {
    if (!localStorage.getItem('importedCandidates')) {
        localStorage.setItem('importedCandidates', JSON.stringify([]));
    }
    console.log('Candidate import tracking initialized');
}

function startAutomaticImport() {
    console.log('Starting automatic candidate import system...');
    
    // Run immediately on page load
    checkAndImportNewCandidates();
    
    // Then check every 30 seconds for new candidates
    autoImportInterval = setInterval(checkAndImportNewCandidates, 30000);
    
    // Also check when table is rendered/updated
    const originalRenderApplications = renderApplications;
    renderApplications = function(data) {
        originalRenderApplications(data);
        setTimeout(checkAndImportNewCandidates, 1000);
    };
}

  // Start automatic import process
  function startAutomaticImport() {
    console.log('Starting automatic import system...');
    
    // Run immediately on page load
    checkAndImportNewCandidates();
    
    // Then check every 30 seconds for new applications
    autoImportInterval = setInterval(checkAndImportNewCandidates, 30000);
    
    // Also check when table is rendered/updated
    const originalRenderApplications = renderApplications;
    renderApplications = function(data) {
      originalRenderApplications(data);
      setTimeout(checkAndImportNewApplications, 1000);
    };
  }

  // Stop automatic import (optional)
  function stopAutomaticImport() {
    if (autoImportInterval) {
      clearInterval(autoImportInterval);
      autoImportInterval = null;
      console.log('Automatic import stopped');
    }
  }

  // Main function to check and import new applications
  // Update the main import function to use candidates
async function checkAndImportNewCandidates() {
    try {
      const rows = document.querySelectorAll('table tbody tr');
      const importedCandidates = JSON.parse(localStorage.getItem('importedCandidates') || '[]');
      
      // Filter new rows that haven't been imported
      const newRows = Array.from(rows).filter(row => {
        const email = row.cells[1]?.textContent.trim();
        const jobTitle = row.cells[2]?.textContent.trim();
        
        return email && jobTitle && 
               email !== 'N/A' && jobTitle !== 'N/A' &&
               !row.dataset.imported &&
               !importedCandidates.some(candidate => candidate.email === email && candidate.job_title === jobTitle);
      });
      
      if (newRows.length === 0) {
        return; // No new candidates found
      }
      
      console.log(`Found ${newRows.length} new candidates to import automatically`);
      
      let importedCount = 0;
      const newlyImported = [];
      
      // Import each new candidate
      for (const row of newRows) {
        try {
          const cells = row.querySelectorAll('td');
          
          // Extract candidate data
          const candidateData = {
            full_name: cells[0].textContent.trim(),
            email: cells[1].textContent.trim(),
            job_title: cells[2].textContent.trim(),
            status: extractStatusFromCell(cells[3])
          };
          
          // Validate required fields
          if (!candidateData.email.includes('@') || candidateData.full_name === 'N/A') {
            continue; // Skip invalid candidates
          }
          
          // Check if already exists in database (additional safety)
          const existingCandidates = await ApiService.getCandidates().catch(() => []);
          const alreadyExists = existingCandidates.some(candidate => 
            candidate.email === candidateData.email && 
            candidate.job_title === candidateData.job_title
          );
          
          if (alreadyExists) {
            // Mark as imported but don't send to API
            newlyImported.push({
              email: candidateData.email,
              job_title: candidateData.job_title,
              timestamp: new Date().toISOString(),
              exists_in_db: true
            });
            row.dataset.imported = 'true';
            continue;
          }
          
          // Send to API
          const result = await ApiService.createCandidate(candidateData);
          console.log('Auto-imported candidate:', candidateData.email);
          
          importedCount++;
          
          // Store in tracking system
          newlyImported.push({
            email: candidateData.email,
            job_title: candidateData.job_title,
            timestamp: new Date().toISOString(),
            id: result.candidate?.id
          });
          
          // Mark as imported
          row.dataset.imported = 'true';
          row.classList.add('auto-imported');
          
          
          
        } catch (error) {
          console.error('Error in auto-import:', error);
          
        }
        
        // Small delay between imports
        await new Promise(resolve => setTimeout(resolve, 500));
      }
      
      // Update imported candidates list
      if (newlyImported.length > 0) {
        const allImported = [...importedCandidates, ...newlyImported];
        localStorage.setItem('importedCandidates', JSON.stringify(allImported));
        
        if (importedCount > 0) {
          showAutoImportNotification(`Automatically imported ${importedCount} new candidates`);
        }
      }
      
    } catch (error) {
      console.error('Auto-import system error:', error);
    }
  }

  

  // Show notification for auto-import
  function showAutoImportNotification(message) {
    // Remove existing notification
    const existingNotification = document.getElementById('autoImportNotification');
    if (existingNotification) {
      existingNotification.remove();
    }
    
    // Create new notification
    const notification = document.createElement('div');
    notification.id = 'autoImportNotification';
    notification.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      background: #10b981;
      color: white;
      padding: 12px 20px;
      border-radius: 6px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 10000;
      font-size: 14px;
      animation: slideIn 0.3s ease;
    `;
    
    notification.textContent = message;
    document.body.appendChild(notification);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
      if (notification.parentNode) {
        notification.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => notification.remove(), 300);
      }
    }, 5000);
  }

  // Helper functions
  function extractStatusFromCell(statusCell) {
    const statusElement = statusCell.querySelector('[class*="status-"]');
    if (statusElement) {
      const classList = statusElement.className.split(' ');
      const statusClass = classList.find(cls => cls.startsWith('status-'));
      if (statusClass) {
        return statusClass.replace('status-', '');
      }
      return statusElement.textContent.trim().toLowerCase();
    }
    return 'pending';
  }

  function extractEducationFromRow(row) {
    const dropdown = row.querySelector('.dropdown-content');
    if (dropdown) {
      const educationSpan = Array.from(dropdown.querySelectorAll('span'))
        .find(span => span.textContent.includes('Formation:') || span.textContent.includes('Education:'));
      if (educationSpan) {
        return educationSpan.textContent.replace(/Formation:|Education:/, '').trim();
      }
    }
    return 'Non sp√©cifi√©';
  }

  function extractCvUrlFromRow(row) {
    const cvLink = row.querySelector('a[href*="#"], a[href*="http"]');
    return cvLink ? cvLink.href : '';
  }

  // Mock API Service for demonstration
  // Replace the ApiService with this CANDIDATES version
const ApiService = {
  getCandidates: async function() {
    try {
      console.log("üîç Fetching candidates from API...");
      const response = await fetch('/api/candidates', {
        method: 'GET',
        credentials: 'include'
      });
      
      console.log(`üìä GET Candidates response: ${response.status} ${response.statusText}`);
      
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }
      
      const data = await response.json();
      console.log(`‚úÖ Found ${data.length} candidates in database`);
      return data;
      
    } catch (error) {
      console.error('Error fetching candidates:', error);
      if (error.message.includes('401') || error.message.includes('403')) {
        showNotification('Session expired. Please log in again.', 'error');
        setTimeout(() => {
          window.location.href = '/login';
        }, 2000);
      }
      throw error;
    }
  },
  
  createCandidate: async function(candidateData) {
    try {
      console.log("üíæ Saving candidate to database:", candidateData);
      const response = await fetch('/api/candidates', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        credentials: 'include',
        body: JSON.stringify(candidateData)
      });
      
      console.log(`üìä POST Candidate response: ${response.status} ${response.statusText}`);
      
      if (!response.ok) {
        const errorText = await response.text();
        console.error(`‚ùå API Error: ${errorText}`);
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }
      
      const result = await response.json();
      console.log("‚úÖ Candidate saved successfully:", result);
      return result;
      
    } catch (error) {
      console.error('Error creating candidate:', error);
      if (error.message.includes('401') || error.message.includes('403')) {
        showNotification('Session expired. Please log in again.', 'error');
        setTimeout(() => {
          window.location.href = '/login';
        }, 2000);
      }
      throw error;
    }
  }
};
// Add this function to check authentication
async function checkAuthentication() {
  try {
    const response = await fetch('/api/check-auth', {
      method: 'GET',
      credentials: 'include'
    });
    
    if (response.ok) {
      const data = await response.json();
      console.log(`üîê Authentication status: ${data.authenticated}`);
      if (data.authenticated) {
        console.log(`üë§ Logged in as: ${data.user.email}`);
        return true;
      }
    }
    return false;
  } catch (error) {
    console.error('Error checking authentication:', error);
    return false;
  }
}

// Update the startAutomaticImport function
async function startAutomaticImport() {
  console.log('Starting automatic candidate import system...');
  
  // Check authentication first
  const isAuthenticated = await checkAuthentication();
  if (!isAuthenticated) {
    console.log('‚ùå Not authenticated. Redirecting to login...');
    showNotification('Please log in to enable automatic import', 'error');
    setTimeout(() => {
      window.location.href = '/login';
    }, 2000);
    return;
  }
  
  // Run immediately on page load
  checkAndImportNewCandidates();
  
  // Then check every 30 seconds for new candidates
  autoImportInterval = setInterval(checkAndImportNewCandidates, 30000);
  
  // Also check when table is rendered/updated
  const originalRenderApplications = renderApplications;
  renderApplications = function(data) {
    originalRenderApplications(data);
    setTimeout(checkAndImportNewCandidates, 1000);
  };
}

    // Toggle profile dropdown
    function toggleProfileDropdown() {
      const dropdown = document.getElementById('profileDropdown');
      dropdown.classList.toggle('show');
    }
    
    // Close dropdowns when clicking elsewhere
    window.onclick = function(event) {
      if (!event.target.matches('.card-menu') && 
          !event.target.matches('.fa-ellipsis-v') &&
          !event.target.matches('.profile-btn') &&
          !event.target.matches('.profile-img') &&
          !event.target.matches('.fa-caret-down')) {
        document.querySelectorAll('.dropdown-content').forEach(dropdown => {
          dropdown.classList.remove('show');
        });
        document.getElementById('profileDropdown').classList.remove('show');
      }
    }
    // Function to open modal
    function openModal(modalId) {
      document.getElementById(modalId).style.display = 'flex';
      document.getElementById('profileDropdown').classList.remove('show');
      return false;
    }
    
    // Function to close modal
    function closeModals(modalId) {
      document.getElementById(modalId).style.display = 'none';
      return false;
    }
    // ==================== PAGINATION ====================
// Pagination variables
let currentPage = 1;
const itemsPerPage = 10;

// Update pagination function
function updatePagination(totalItems) {
    const totalPages = Math.ceil(totalItems / itemsPerPage);
    const paginationInfo = document.querySelector('.pagination-info');
    const paginationButtons = document.querySelector('.pagination-buttons');
    const prevPageBtn = paginationButtons.querySelector('.pagination-btn:first-child');
    const nextPageBtn = paginationButtons.querySelector('.pagination-btn:last-child');
    
    if (!paginationInfo || !paginationButtons) return;
    
    // Update pagination info
    const startItem = (currentPage - 1) * itemsPerPage + 1;
    const endItem = Math.min(currentPage * itemsPerPage, totalItems);
    paginationInfo.textContent = totalItems === 0 ? 
        'Aucune candidature' : 
        `Affichage de ${startItem} √† ${endItem} sur ${totalItems} candidatures`;
    
    // Update pagination buttons
    if (prevPageBtn) prevPageBtn.disabled = currentPage === 1;
    if (nextPageBtn) nextPageBtn.disabled = currentPage === totalPages || totalPages === 0;
    
    // Remove all page number buttons (except prev/next)
    const pageButtons = paginationButtons.querySelectorAll('.pagination-btn:not(:first-child):not(:last-child)');
    pageButtons.forEach(btn => btn.remove());
    
    // Add page number buttons between prev and next buttons
    if (totalPages > 0) {
        const nextBtn = paginationButtons.querySelector('.pagination-btn:last-child');
        for (let i = 1; i <= totalPages; i++) {
            const pageBtn = document.createElement('button');
            pageBtn.className = `pagination-btn ${i === currentPage ? 'active' : ''}`;
            pageBtn.textContent = i;
            pageBtn.onclick = () => changePage(i);
            nextBtn.parentNode.insertBefore(pageBtn, nextBtn);
        }
    }
}

// Change page function
function changePage(page) {
    currentPage = page;
    renderApplications(applicationsData);
}

// Update renderApplications function to include pagination
const originalRenderApplications = renderApplications;
renderApplications = function(data) {
    if (!data || data.length === 0) {
        const tbody = document.getElementById("applicationsTableBody");
        if (tbody) {
            tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;">Aucune candidature trouv√©e</td></tr>';
        }
        updatePagination(0);
        return;
    }
    
    // Apply pagination
    const startIndex = (currentPage - 1) * itemsPerPage;
    const endIndex = startIndex + itemsPerPage;
    const paginatedData = data.slice(startIndex, endIndex);
    
    // Call original function with paginated data
    originalRenderApplications(paginatedData);
    
    // Update pagination controls
    updatePagination(data.length);
};

// Initialize pagination when applications are loaded
const originalLoadApplications = loadApplications;
loadApplications = function() {
    try {
        showLoadingState(true);
        
        // Load from localStorage
        const localData = localStorage.getItem('jobApplications');
        if (localData) {
            try {
                applicationsData = JSON.parse(localData).map(processApplicationData);
                renderApplications(applicationsData);
            } catch (e) {
                console.error('Error parsing local data:', e);
                showErrorState('Erreur de chargement des donn√©es locales');
            }
        } else {
            showNoDataState();
        }
    } catch (error) {
        console.error('Loading failed:', error);
        showErrorState('Erreur de chargement');
    } finally {
        showLoadingState(false);
    }
    
    return applicationsData;
};

// Initialize pagination when DOM is loaded
document.addEventListener("DOMContentLoaded", function() {
    // Show pagination immediately
    updatePagination(0);
    
    // Initialize other components
    initSearch();
    initFilter();
    
    // Load applications from localStorage
    loadApplications();
    
    // Check if there's a new application to add
    checkForNewApplication();
    
    // Initialize automatic import system
    initializeImportTracking();
    startAutomaticImport();
});
// Open modal with candidate details
function openCandidateModal(fullName, educationLevel) {
  document.getElementById("modal-fullname").textContent = fullName;
  document.getElementById("modal-education").textContent = educationLevel;
  document.getElementById("viewMoreModal").style.display = "block";
}// Close modal
function closeModalviewmore(modalId) {
  document.getElementById(modalId).style.display = "none";
}
  </script>
</body>
</html>